#!/bin/bash

FILE="$HOME/.nts.md"
EDITOR="${EDITOR:-nano}"
CONFIG="$HOME/.config/nts/config"
COMPLETION_ENABLED=1

[[ -f "$CONFIG" ]] && source "$CONFIG"


init_file() {
  if [[ ! -f "$FILE" ]]; then
    cat <<EOF > "$FILE"
# üß† Notes To Self

## üîÑ Ty√∂n alla

## ‚úÖ Valmiit
EOF
  fi
}

add_note() {
  init_file
  NOTE="$1"
  TIMESTAMP="$(date '+%d.%m.%Y %H:%M')"
  sed -i "/## üîÑ Ty√∂n alla/a - [ ] $NOTE _($TIMESTAMP)_" "$FILE"
  echo "‚ûï Lis√§tty: $NOTE"
}

list_notes() {
  init_file
  awk '
    /## üîÑ Ty√∂n alla/ {flag=1; next}
    /##/ {flag=0}
    flag {
      if (index($0, "_(") > 0 && index($0, "-") > 0) {
        # poimi p√§iv√§m√§√§r√§ k√§sin
        start = index($0, "_(") + 2
        iso = substr($0, start, 10)   # YYYY-MM-DD
        split(iso, d, "-")
        if (length(d[1]) == 4) {
          eu = d[3] "." d[2] "." d[1]
          sub(iso, eu)
        }
      }
      print
    }
  ' "$FILE" | nl
}




mark_done() {
  init_file
  LINE=$(list_notes | sed -n "${1}p" | cut -f2-)
  [[ -z "$LINE" ]] && echo "‚ùå Ei l√∂ytynyt" && exit 1

  sed -i "/$LINE/d" "$FILE"
  sed -i "/## ‚úÖ Valmiit/a ${LINE/\[ \]/[x]}" "$FILE"
  echo "‚úÖ Merkitty valmiiksi"
}

edit_notes() {
  init_file
  $EDITOR "$FILE"
}

case "$1" in
  add)
    shift
    add_note "$*"
    ;;
  list)
    list_notes
    ;;
  done)
    NUM="${2%%:*}"
    mark_done "$NUM"
    ;;
  edit)
    edit_notes
    ;;
  config)
    mkdir -p "$(dirname "$CONFIG")"
    case "$2" in
      completion)
        case "$3" in
          on)
            echo "COMPLETION_ENABLED=1" > "$CONFIG"
            echo "‚úÖ Autocomplete k√§yt√∂ss√§"
            ;;
          off)
            echo "COMPLETION_ENABLED=0" > "$CONFIG"
            echo "üö´ Autocomplete pois k√§yt√∂st√§"
            ;;
          *)
            echo "K√§ytt√∂: nts config completion on|off"
            ;;
        esac
        ;;
      *)
        echo "Tuntematon asetus"
        ;;
    esac
    ;;
  *)
    echo "K√§ytt√∂:"
    echo "  nts add \"Muistettava asia\""
    echo "  nts list"
    echo "  nts done <numero>"
    echo "  nts edit"
    echo "  nts config completion on|off"
    ;;
esac

