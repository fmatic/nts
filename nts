#!/bin/bash

FILE="$HOME/.nts.md"
EDITOR="${EDITOR:-nano}"
CONFIG="$HOME/.config/nts/config"
COMPLETION_ENABLED=1

# Colors (disable if NO_COLOR is set)
if [[ -t 1 && -z "$NO_COLOR" ]]; then
  C_RESET="\033[0m"
  C_GRAY="\033[90m"
  C_YELLOW="\033[33m"
  C_GREEN="\033[32m"
  C_BLUE="\033[34m"
  C_MAGENTA="\033[35m"
else
  C_RESET=""
  C_GRAY=""
  C_YELLOW=""
  C_GREEN=""
  C_BLUE=""
  C_MAGENTA=""
fi


[[ -f "$CONFIG" ]] && source "$CONFIG"


init_file() {
  if [[ ! -f "$FILE" ]]; then
    cat <<EOF > "$FILE"
# üß† Notes To Self

## üîÑ Ty√∂n alla

## ‚úÖ Valmiit
EOF
  fi
}

add_note() {
  init_file
  NOTE="$1"
  TIMESTAMP="$(date '+%d.%m.%Y %H:%M')"
  sed -i "/## üîÑ Ty√∂n alla/a - [ ] $NOTE _($TIMESTAMP)_" "$FILE"
  echo "‚ûï Lis√§tty: $NOTE"
}

list_notes() {
  init_file
  awk -v gray="$C_GRAY" -v yellow="$C_YELLOW" -v green="$C_GREEN" \
      -v blue="$C_BLUE" -v magenta="$C_MAGENTA" -v reset="$C_RESET" '
    /## üîÑ Ty√∂n alla/ {flag=1; next}
    /##/ {flag=0}
    flag {
      line = $0

      # N√§yt√§ vain oikeat teht√§v√§t
      if (line !~ /^\- \[[ x]\] /) next

      # EU-p√§iv√§m√§√§r√§muunnos (BusyBox-safe)
      if (index(line, "_(") > 0 && index(line, "-") > 0) {
        start = index(line, "_(") + 2
        iso = substr(line, start, 10)   # YYYY-MM-DD
        split(iso, d, "-")
        if (length(d[1]) == 4) {
          eu = d[3] "." d[2] "." d[1]
          sub(iso, eu, line)
        }
      }

      i++

      # Status
      if (line ~ /^\- \[ \]/) {
        status = yellow "[ ]" reset
      } else if (line ~ /^\- \[x\]/) {
        status = green "[x]" reset
      }

      # Poista Markdown-status
      sub(/^\- \[[ x]\] /, "", line)

      # V√§rit√§ p√§iv√§m√§√§r√§
      gsub(/_\([0-9]{2}\.[0-9]{2}\.[0-9]{4} [0-9]{2}:[0-9]{2}\)_/,
           blue "&" reset, line)

      # V√§rit√§ tagit
      gsub(/#[a-zA-Z0-9_-]+/, magenta "&" reset, line)

      # Tulostus
      printf "%s%2d%s  %s %s\n", gray, i, reset, status, line
    }
  ' "$FILE"
}


mark_done() {
  init_file
  LINE=$(list_notes | sed -n "${1}p" | cut -f2-)
  [[ -z "$LINE" ]] && echo "‚ùå Ei l√∂ytynyt" && exit 1

  sed -i "/$LINE/d" "$FILE"
  sed -i "/## ‚úÖ Valmiit/a ${LINE/\[ \]/[x]}" "$FILE"
  echo "‚úÖ Merkitty valmiiksi"
}

edit_notes() {
  init_file
  $EDITOR "$FILE"
}

case "$1" in
  add)
    shift
    add_note "$*"
    ;;
  list)
    list_notes
    ;;
  done)
    NUM="${2%%:*}"
    mark_done "$NUM"
    ;;
  edit)
    edit_notes
    ;;
  config)
    mkdir -p "$(dirname "$CONFIG")"
    case "$2" in
      completion)
        case "$3" in
          on)
            echo "COMPLETION_ENABLED=1" > "$CONFIG"
            echo "‚úÖ Autocomplete k√§yt√∂ss√§"
            ;;
          off)
            echo "COMPLETION_ENABLED=0" > "$CONFIG"
            echo "üö´ Autocomplete pois k√§yt√∂st√§"
            ;;
          *)
            echo "K√§ytt√∂: nts config completion on|off"
            ;;
        esac
        ;;
      *)
        echo "Tuntematon asetus"
        ;;
    esac
    ;;
  *)
    echo "K√§ytt√∂:"
    echo "  nts add \"Muistettava asia\""
    echo "  nts list"
    echo "  nts done <numero>"
    echo "  nts edit"
    echo "  nts config completion on|off"
    ;;
esac

