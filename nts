#!/bin/bash

FILE="$HOME/.nts.md"
EDITOR="${EDITOR:-nano}"
CONFIG="$HOME/.config/nts/config"
COMPLETION_ENABLED=1
TODAY="$(date '+%d.%m.%Y')"

# Colors (disable if NO_COLOR is set)
if [[ -t 1 && -z "$NO_COLOR" ]]; then
  C_RESET="\033[0m"
  C_GRAY="\033[90m"
  C_YELLOW="\033[33m"
  C_GREEN="\033[32m"
  C_BLUE="\033[34m"
  C_MAGENTA="\033[35m"
else
  C_RESET=""
  C_GRAY=""
  C_YELLOW=""
  C_GREEN=""
  C_BLUE=""
  C_MAGENTA=""
fi


[[ -f "$CONFIG" ]] && source "$CONFIG"


init_file() {
  if [[ ! -f "$FILE" ]]; then
    cat <<EOF > "$FILE"
# ðŸ§  Notes To Self

## ðŸ”„ TyÃ¶n alla

## âœ… Valmiit
EOF
  fi
}

add_note() {
  init_file
  NOTE="$1"
  TIMESTAMP="$(date '+%d.%m.%Y %H:%M')"
  sed -i "/## ðŸ”„ TyÃ¶n alla/a - [ ] $NOTE _($TIMESTAMP)_" "$FILE"
  echo "âž• LisÃ¤tty: $NOTE"
}

list_notes() {
  init_file

  local show_done=0
  local filter_tag=""
  local filter_today=0

  for arg in "$@"; do
    case "$arg" in
      --done) show_done=1 ;;
      --today) filter_today=1 ;;
      \#*) filter_tag="$arg" ;;
    esac
  done

  awk -v gray="$C_GRAY" -v yellow="$C_YELLOW" -v green="$C_GREEN" \
      -v blue="$C_BLUE" -v magenta="$C_MAGENTA" -v reset="$C_RESET" \
      -v show_done="$show_done" -v tag="$filter_tag" \
      -v today="$TODAY" -v only_today="$filter_today" '
    /## ðŸ”„ TyÃ¶n alla/ {section="todo"; next}
    /## âœ… Valmiit/ {section="done"; next}
    /^## / {section=""; next}

    section != "" {
      line = $0

      # vain tehtÃ¤vÃ¤t
      if (line !~ /^\- \[[ x]\] /) next

      # done / todo -filtteri
      if (section == "done" && !show_done) next
      if (section == "todo" && show_done) next

      # tag-filtteri
      if (tag != "" && line !~ tag) next

      # EU-pÃ¤ivÃ¤mÃ¤Ã¤rÃ¤
      if (index(line, "_(") > 0 && index(line, "-") > 0) {
        start = index(line, "_(") + 2
        iso = substr(line, start, 10)
        split(iso, d, "-")
        if (length(d[1]) == 4) {
          eu = d[3] "." d[2] "." d[1]
          sub(iso, eu, line)
        }
      }

      # today-filtteri
      if (only_today && line !~ today) next

      i++

      if (line ~ /^\- \[ \]/) status = yellow "[ ]" reset
      else status = green "[x]" reset

      sub(/^\- \[[ x]\] /, "", line)

      gsub(/_\([0-9]{2}\.[0-9]{2}\.[0-9]{4} [0-9]{2}:[0-9]{2}\)_/,
           blue "&" reset, line)

      gsub(/#[a-zA-Z0-9_-]+/, magenta "&" reset, line)

      printf "%s%2d%s  %s %s\n", gray, i, reset, status, line
    }
  ' "$FILE"
}



mark_done() {
  init_file
  LINE=$(list_notes | sed -n "${1}p" | cut -f2-)
  [[ -z "$LINE" ]] && echo "âŒ Ei lÃ¶ytynyt" && exit 1

  sed -i "/$LINE/d" "$FILE"
  sed -i "/## âœ… Valmiit/a ${LINE/\[ \]/[x]}" "$FILE"
  echo "âœ… Merkitty valmiiksi"
}

edit_notes() {
  init_file
  $EDITOR "$FILE"
}

list_tags() {
  init_file
  awk '
    /## ðŸ”„ TyÃ¶n alla|## âœ… Valmiit/ {flag=1; next}
    /^## / {flag=0}
    flag {
      while (match($0, /#[a-zA-Z0-9_-]+/)) {
        tag = substr($0, RSTART, RLENGTH)
        count[tag]++
        $0 = substr($0, RSTART + RLENGTH)
      }
    }
    END {
      for (t in count)
        printf "%-12s %d\n", t, count[t]
    }
  ' "$FILE" | sort
}

nts_stats() {
  init_file

  local total todo done tags
  total=$(grep -E '^\- \[[ x]\]' "$FILE" | wc -l)
  todo=$(grep -E '^\- \[ \]' "$FILE" | wc -l)
  done=$(grep -E '^\- \[x\]' "$FILE" | wc -l)
  tags=$(grep -o '#[a-zA-Z0-9_-]\+' "$FILE" | sort -u | wc -l)

  echo "Tasks total : $total"
  echo "Todo        : $todo"
  echo "Done        : $done"
  echo "Tags        : $tags"
  echo "File        : $FILE"
}

nts_doctor() {
  echo "NTS Doctor"
  echo "----------"

  command -v nts >/dev/null && echo "âœ” nts executable found" || echo "âœ– nts not in PATH"
  [[ -f "$FILE" ]] && echo "âœ” data file exists" || echo "âš  data file missing"
  command -v awk >/dev/null && echo "âœ” awk available" || echo "âœ– awk missing"
  command -v sed >/dev/null && echo "âœ” sed available" || echo "âœ– sed missing"
  command -v git >/dev/null && echo "âœ” git available" || echo "âš  git not installed"

  if [[ "$COMPLETION_ENABLED" == "1" ]]; then
    echo "âœ” completion enabled"
  else
    echo "âš  completion disabled"
  fi
}

nts_sync() {
  init_file
  local dir
  dir="$(dirname "$FILE")"

  if [[ ! -d "$dir/.git" ]]; then
    echo "âŒ $dir ei ole git-repo"
    return 1
  fi

  cd "$dir" || return 1

  git add "$(basename "$FILE")"
  git commit -m "Update nts notes" >/dev/null 2>&1 || true
  git pull --rebase
  git push

  echo "âœ” synced"
}


case "$1" in
  add)
    shift
    add_note "$*"
    ;;
  list)
    shift
    list_notes "$@"
    ;;
  done)
    NUM="${2%%:*}"
    mark_done "$NUM"
    ;;
  edit)
    edit_notes
    ;;
  tags)
  list_tags
  ;;
  stats)
  nts_stats
  ;;
  doctor)
  nts_doctor
  ;;
 sync)
  nts_sync
  ;;

  config)
    mkdir -p "$(dirname "$CONFIG")"
    case "$2" in
      completion)
        case "$3" in
          on)
            echo "COMPLETION_ENABLED=1" > "$CONFIG"
            echo "âœ… Autocomplete kÃ¤ytÃ¶ssÃ¤"
            ;;
          off)
            echo "COMPLETION_ENABLED=0" > "$CONFIG"
            echo "ðŸš« Autocomplete pois kÃ¤ytÃ¶stÃ¤"
            ;;
          *)
            echo "KÃ¤yttÃ¶: nts config completion on|off"
            ;;
        esac
        ;;
      *)
        echo "Tuntematon asetus"
        ;;
    esac
    ;;
  install)
    echo "ðŸ”§ Installing nts..."

    sudo install -m 755 "$0" /usr/local/bin/nts

    if [[ -n "$BASH_VERSION" ]]; then
      sudo mkdir -p /etc/bash_completion.d
      sudo install -m 644 "$(dirname "$0")/completions/nts.bash" \
        /etc/bash_completion.d/nts
      echo "âœ” Bash completion installed"
    fi

    if [[ -n "$ZSH_VERSION" ]]; then
      mkdir -p ~/.zsh/completions
      install -m 644 "$(dirname "$0")/completions/_nts" \
        ~/.zsh/completions/_nts
      echo "âœ” Zsh completion installed"
    fi

    echo "âœ… Done. Restart shell."
    ;;
  *)
    echo "KÃ¤yttÃ¶:"
    echo "  nts add \"Muistettava asia\""
    echo "  nts list [#tag] [--today] [--done]"
    echo "  nts done <numero>"
    echo "  nts edit"
    echo "  nts config completion on|off"
    echo "  nts install"
    ;;
esac
